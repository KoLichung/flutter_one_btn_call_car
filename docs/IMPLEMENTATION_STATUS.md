# ä¸€éµå«è»Š Flutter App - API é›†æˆå®Œæˆ

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. **é¡¹ç›®æ¶æ„**

```
lib/
â”œâ”€â”€ main.dart                      # å¯åŠ¨é¡µï¼ˆæ£€æŸ¥ç™»å½•çŠ¶æ€ï¼‰
â”œâ”€â”€ models/                        # æ•°æ®æ¨¡å‹
â”‚   â”œâ”€â”€ customer.dart              # å®¢æˆ·æ¨¡å‹ï¼ˆå¯¹åº”åç«¯ Customerï¼‰
â”‚   â”œâ”€â”€ customer.g.dart            # JSON åºåˆ—åŒ–ç”Ÿæˆæ–‡ä»¶
â”‚   â”œâ”€â”€ driver.dart                # å¸æœºæ¨¡å‹
â”‚   â”œâ”€â”€ driver.g.dart
â”‚   â”œâ”€â”€ ride_record.dart           # è®¢å•è®°å½•æ¨¡å‹
â”‚   â””â”€â”€ ride_record.g.dart
â”œâ”€â”€ services/                      # ä¸šåŠ¡é€»è¾‘å±‚
â”‚   â”œâ”€â”€ api_service.dart           # æ ¸å¿ƒ API æœåŠ¡ï¼ˆåŒ…å« base URLï¼‰
â”‚   â”œâ”€â”€ auth_service.dart          # è®¤è¯æœåŠ¡
â”‚   â”œâ”€â”€ ride_service.dart          # å«è½¦æœåŠ¡
â”‚   â””â”€â”€ storage_service.dart       # æœ¬åœ°å­˜å‚¨æœåŠ¡
â””â”€â”€ screens/                       # é¡µé¢
    â”œâ”€â”€ login_page.dart            # ç™»å½•é¡µï¼ˆä½¿ç”¨çœŸå® APIï¼‰
    â”œâ”€â”€ register_page.dart         # æ³¨å†Œé¡µï¼ˆä½¿ç”¨çœŸå® APIï¼‰
    â”œâ”€â”€ home_page.dart             # ä¸»é¡µï¼ˆTab åˆ‡æ¢ï¼‰
    â”œâ”€â”€ call_car_page.dart         # å«è½¦é¡µï¼ˆé›†æˆå®æ—¶è¿½è¸ªï¼‰
    â”œâ”€â”€ profile_page.dart          # ä¸ªäººèµ„æ–™é¡µï¼ˆä½¿ç”¨çœŸå® APIï¼‰
    â”œâ”€â”€ ride_history_page.dart     # å†å²è®°å½•é¡µï¼ˆä½¿ç”¨çœŸå® APIï¼‰
    â””â”€â”€ ride_detail_page.dart      # è®¢å•è¯¦æƒ…é¡µ
```

### 2. **æ ¸å¿ƒåŠŸèƒ½å®ç°**

#### âœ… è®¤è¯åŠŸèƒ½
- **æ‰‹æœºå·æ³¨å†Œ**: `AuthService.register()`
- **æ‰‹æœºå·ç™»å½•**: `AuthService.login()`
- **è‡ªåŠ¨ç™»å½•æ£€æŸ¥**: å¯åŠ¨æ—¶æ£€æŸ¥ `isLoggedIn()`
- **ç™»å‡º**: `AuthService.logout()` å¹¶æ¸…é™¤æœ¬åœ°æ•°æ®
- **Session ç®¡ç†**: ä½¿ç”¨ Cookie è‡ªåŠ¨ç®¡ç†

#### âœ… å«è½¦åŠŸèƒ½
- **ä¸€é”®å«è½¦**: `RideService.callCar()` - ä½¿ç”¨å½“å‰ä½ç½®
- **å®æ—¶è¿½è¸ª**: `RideService.startTracking()` - æ¯ 3 ç§’è½®è¯¢
- **å¸æœºä½ç½®æ˜¾ç¤º**: åœ°å›¾ä¸Šå®æ—¶æ›´æ–°å¸æœºæ ‡è®°
- **è®¢å•çŠ¶æ€æ›´æ–°**: æ ¹æ® `case_state` è‡ªåŠ¨æ›´æ–° UI
- **å–æ¶ˆè®¢å•**: `RideService.cancelCase()`

#### âœ… å†å²è®°å½•
- **æŸ¥çœ‹å†å²**: `RideService.getHistory()` - æ”¯æŒåˆ†é¡µ
- **ä¸‹æ‹‰åˆ·æ–°**: RefreshIndicator é›†æˆ

#### âœ… ä¸ªäººèµ„æ–™
- **æŸ¥çœ‹èµ„æ–™**: `AuthService.getCurrentCustomer()`
- **ç™»å‡ºç¡®è®¤**: å¸¦ç¡®è®¤å¯¹è¯æ¡†çš„ç™»å‡ºæµç¨‹

### 3. **API é›†æˆè¯¦æƒ…**

#### Base URL
```dart
https://ai-taxi-api-5koy2twboa-de.a.run.app/api/one-btn-call-car/
```

#### å·²é›†æˆçš„ API ç«¯ç‚¹

| åŠŸèƒ½ | æ–¹æ³• | ç«¯ç‚¹ | çŠ¶æ€ |
|------|------|------|------|
| æ³¨å†Œ | POST | `auth/register/` | âœ… |
| ç™»å½• | POST | `auth/login/` | âœ… |
| ç™»å‡º | POST | `auth/logout/` | âœ… |
| è·å–ç”¨æˆ·èµ„æ–™ | GET | `auth/profile/` | âœ… |
| ä¸€é”®å«è½¦ | POST | `call-car/` | âœ… |
| è¿½è¸ªè®¢å• | GET | `case/{case_id}/tracking/` | âœ… |
| å–æ¶ˆè®¢å• | POST | `case/{case_id}/cancel/` | âœ… |
| å†å²è®°å½• | GET | `cases/history/` | âœ… |

### 4. **è®¢å•çŠ¶æ€æµç¨‹**

```
idle (é—²ç½®)
  â†“ [ç‚¹å‡»å«è½¦]
calling (å«è½¦ä¸­)
  â†“ [API è¿”å›]
waiting (ç­‰å¾…æ´¾å•) - case_state: 'wait' / 'dispatching'
  â†“ [å¸æœºæ¥å•]
driverOnWay (å¸æœºå‰å¾€) - case_state: 'way_to_catch'
  â†“ [å¸æœºåˆ°è¾¾]
arrived (å¸æœºåˆ°è¾¾) - case_state: 'arrived'
  â†“ [ä¹˜å®¢ä¸Šè½¦]
onBoard (è¡Œé©¶ä¸­) - case_state: 'catched' / 'on_road'
  â†“ [åˆ°è¾¾ç›®çš„åœ°]
finished (è¡Œç¨‹ç»“æŸ) - case_state: 'finished'
  â†“
idle (å›åˆ°é—²ç½®)
```

### 5. **åœ°å›¾åŠŸèƒ½**

#### âœ… Google Maps é›†æˆ
- æ˜¾ç¤ºå½“å‰ä½ç½®
- æ˜¾ç¤ºå¸æœºä½ç½®ï¼ˆè‡ªå®šä¹‰è“è‰²åœ†å½¢æ ‡è®°ï¼‰
- è‡ªåŠ¨è°ƒæ•´è§†é‡æ˜¾ç¤ºå¸æœºå’Œä¹˜å®¢ä½ç½®
- å®šä½æŒ‰é’®

#### âœ… å®æ—¶è¿½è¸ª
- æ¯ 3 ç§’æ›´æ–°å¸æœºä½ç½®
- è®¢å•çŠ¶æ€æ”¹å˜æ—¶è‡ªåŠ¨åœæ­¢è¿½è¸ª
- åœ°å›¾æ ‡è®°å®æ—¶æ›´æ–°

### 6. **æœ¬åœ°å­˜å‚¨**

ä½¿ç”¨ `SharedPreferences` å­˜å‚¨ï¼š
- ç”¨æˆ·ä¿¡æ¯ï¼ˆCustomer JSONï¼‰
- customer_id
- ç™»å½•çŠ¶æ€æ ‡å¿—

### 7. **é”™è¯¯å¤„ç†**

- ç½‘ç»œè¯·æ±‚å¤±è´¥æç¤º
- ç™»å½•å¤±è´¥æç¤º
- å«è½¦å¤±è´¥æç¤º
- ç©ºçŠ¶æ€æ˜¾ç¤ºï¼ˆæ— å†å²è®°å½•ç­‰ï¼‰

## ğŸ“¦ ä¾èµ–åŒ…

```yaml
dependencies:
  dio: ^5.4.0                    # HTTP å®¢æˆ·ç«¯
  cookie_jar: ^4.0.8             # Cookie ç®¡ç†
  dio_cookie_manager: ^3.1.1     # Dio Cookie æ’ä»¶
  shared_preferences: ^2.2.2     # æœ¬åœ°å­˜å‚¨
  json_annotation: ^4.8.1        # JSON åºåˆ—åŒ–æ³¨è§£
  google_maps_flutter: ^2.5.0    # Google Maps
  geolocator: ^10.1.0            # å®šä½æœåŠ¡

dev_dependencies:
  build_runner: ^2.4.7           # ä»£ç ç”Ÿæˆ
  json_serializable: ^6.7.1      # JSON åºåˆ—åŒ–ç”Ÿæˆå™¨
```

## ğŸš€ å¦‚ä½•è¿è¡Œ

### 1. å®‰è£…ä¾èµ–
```bash
flutter pub get
```

### 2. ç”Ÿæˆ JSON åºåˆ—åŒ–ä»£ç ï¼ˆå¦‚éœ€è¦ï¼‰
```bash
flutter pub run build_runner build --delete-conflicting-outputs
```

### 3. é…ç½® Google Maps API Key
- Android: `android/app/src/main/AndroidManifest.xml`
- iOS: `ios/Runner/AppDelegate.swift`

### 4. è¿è¡Œåº”ç”¨
```bash
flutter run
```

## ğŸ¯ æ ¸å¿ƒç‰¹æ€§

### 1. **æ— éœ€ Provider**
- æ‰€æœ‰çŠ¶æ€ç®¡ç†é€šè¿‡ Service å±‚å¤„ç†
- é¡µé¢ç›´æ¥è°ƒç”¨ Service æ–¹æ³•
- ä½¿ç”¨ `setState()` æ›´æ–° UI

### 2. **Session è®¤è¯**
- ä½¿ç”¨ Django Session Cookie
- è‡ªåŠ¨ä¿å­˜å’Œå‘é€ Cookie
- ç™»å½•åè‡ªåŠ¨è®¤è¯æ‰€æœ‰è¯·æ±‚

### 3. **å®æ—¶è¿½è¸ª**
- è½®è¯¢æœºåˆ¶ï¼ˆæ¯ 3 ç§’ï¼‰
- è‡ªåŠ¨åœæ­¢è¿½è¸ªï¼ˆè®¢å•å®Œæˆ/å–æ¶ˆï¼‰
- åœ°å›¾å®æ—¶æ›´æ–°

### 4. **ç®€æ´æ¶æ„**
- Models: æ•°æ®æ¨¡å‹
- Services: ä¸šåŠ¡é€»è¾‘
- Screens: UI å±•ç¤º
- æ—  Provider/utils/widgets å±‚

## ğŸ”§ åç»­å¯èƒ½çš„ä¼˜åŒ–

1. **Geocoding**: ä½¿ç”¨ Google Geocoding API è·å–è¯¦ç»†åœ°å€
2. **LINE ç™»å½•**: é›†æˆ LINE SDK
3. **æ¨é€é€šçŸ¥**: å¸æœºæ¥å•æ—¶æ¨é€é€šçŸ¥
4. **åœ°å›¾è·¯çº¿**: ä½¿ç”¨ Directions API æ˜¾ç¤ºè·¯çº¿
5. **è¯„ä»·åŠŸèƒ½**: è¡Œç¨‹ç»“æŸåè¯„ä»·å¸æœº

## ğŸ“ API æ–‡æ¡£ä½ç½®

è¯¦ç»†çš„ API æ–‡æ¡£åœ¨é¡¹ç›®æ ¹ç›®å½•çš„ç”¨æˆ·æä¾›çš„æ–‡æ¡£ä¸­ã€‚

## âœ… æµ‹è¯•å»ºè®®

1. **æ³¨å†Œæµç¨‹**: ä½¿ç”¨æµ‹è¯•æ‰‹æœºå·æ³¨å†Œ
2. **ç™»å½•æµç¨‹**: æµ‹è¯•è‡ªåŠ¨ç™»å½•åŠŸèƒ½
3. **å«è½¦æµç¨‹**: 
   - æµ‹è¯•å«è½¦è¯·æ±‚
   - è§‚å¯Ÿè®¢å•çŠ¶æ€å˜åŒ–
   - æµ‹è¯•å–æ¶ˆè®¢å•
4. **åœ°å›¾åŠŸèƒ½**: 
   - æµ‹è¯•å®šä½æƒé™
   - è§‚å¯Ÿå¸æœºä½ç½®æ›´æ–°
5. **å†å²è®°å½•**: æŸ¥çœ‹å®Œæˆçš„è®¢å•

## ğŸ‰ å®ŒæˆçŠ¶æ€

æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½å·²å®Œæˆï¼åº”ç”¨å¯ä»¥æ­£å¸¸è¿è¡Œå’Œæµ‹è¯•ã€‚

